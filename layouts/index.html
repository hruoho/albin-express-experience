{{ define "main" }}
<section class="hero">
  {{ with .Params.heroSlides }}
  {{ range $i, $slide := . }}
  {{ if $slide.video }}
  <video class="hero__slide{{ if eq $i 0 }} hero__slide--active{{ end }}" muted playsinline loop{{ if eq $i 0 }} preload="auto" poster="{{ "images/hero-poster.jpg" | relURL }}"{{ else }} preload="none"{{ end }}>
    <source src="{{ $slide.src | relURL }}" type="video/mp4">
  </video>
  {{ else }}
  <img src="{{ $slide.src | relURL }}" alt="{{ $slide.alt }}" class="hero__slide{{ if eq $i 0 }} hero__slide--active{{ end }}"{{ if ne $i 0 }} loading="lazy"{{ end }}>
  {{ end }}
  {{ end }}
  {{ else }}
  <img src="{{ (.Params.heroImage | default "images/gallery/hero.jpg") | relURL }}" alt="Albin Express under sail" class="hero__slide hero__slide--active">
  {{ end }}
  <div class="hero__overlay">
    <h1 class="hero__title">{{ .Title }}</h1>
    <p class="hero__subtitle">{{ .Params.subtitle }}</p>
  </div>
</section>

{{ with .Params.heroSlides }}
<script>
(function() {
  var slides = document.querySelectorAll('.hero__slide');
  if (slides.length < 2) return;
  var current = 0;
  var FADE_MS = 800;
  var PRELOAD_AHEAD_MS = 2000;
  function preloadSlide(idx) {
    var s = slides[idx];
    if (s.tagName === 'VIDEO' && s.preload === 'none') s.preload = 'auto';
  }
  function scheduleNext(delay) {
    var nextIdx = (current + 1) % slides.length;
    setTimeout(function() { preloadSlide(nextIdx); }, Math.max(delay - PRELOAD_AHEAD_MS, 0));
    setTimeout(next, delay);
  }
  function next() {
    var cur = slides[current];
    current = (current + 1) % slides.length;
    var nxt = slides[current];
    if (nxt.tagName === 'VIDEO') nxt.play();
    nxt.classList.add('hero__slide--active');
    cur.classList.remove('hero__slide--active');
    setTimeout(function() {
      if (cur.tagName === 'VIDEO') { cur.pause(); cur.currentTime = 0; }
    }, FADE_MS);
    var duration = nxt.tagName === 'VIDEO' ? (nxt.duration || 5) * 1000 - FADE_MS : 5000;
    scheduleNext(Math.max(duration, 2000));
  }
  var first = slides[0];
  if (first.tagName === 'VIDEO') first.play();
  var startDuration = first.tagName === 'VIDEO' ? (first.duration || 5) * 1000 - FADE_MS : 5000;
  scheduleNext(Math.max(startDuration, 2000));
})();
</script>
{{ end }}

<section class="section">
  <div class="section--narrow">
    {{ .Content }}
  </div>
</section>

{{ with .Params.gallery }}
<section class="section">
  <div class="gallery">
    {{ range . }}
    <a href="{{ .src | relURL }}" class="gallery__link" target="_blank">
      <img src="{{ .src | relURL }}" alt="{{ .alt }}" class="gallery__image">
    </a>
    {{ end }}
  </div>
</section>
{{ end }}

{{ with .Params.reviews }}
<section class="section">
  {{ with $.Params.rating }}
  <p class="rating">
    <span class="rating__score">{{ . }}/10</span>
    <span class="rating__source">Friilo Â· {{ $.Params.ratingCount }} {{ if eq $.Lang "fi" }}arvostelua{{ else }}reviews{{ end }}</span>
  </p>
  {{ end }}
  <div class="reviews">
    {{ range . }}
    <blockquote class="review">
      <p>{{ .text }}</p>
    </blockquote>
    {{ end }}
  </div>
</section>
{{ end }}

{{ with .Params.pricing }}
<section class="section">
  <h2>{{ $.Params.pricingTitle | default "Pricing" }}</h2>
  <div class="card-grid">
    {{ range . }}
    <div class="card">
      <p class="label">{{ .label }}</p>
      <h3 class="card__title">{{ .title }}</h3>
      <p class="card__price">{{ .price }}</p>
      {{ with .details }}
      {{ range . }}
      <p class="card__detail">{{ . }}</p>
      {{ end }}
      {{ end }}
    </div>
    {{ end }}
  </div>
  {{ with $.Params.bookingUrl }}
  <p style="margin-top: 1.5rem;"><a href="{{ . }}" class="btn" target="_blank" rel="noopener">{{ if eq $.Lang "fi" }}Varaa Friilosta{{ else }}Book on Friilo{{ end }}</a></p>
  {{ end }}
</section>
{{ end }}

<section class="section">
  <h2>{{ .Params.contactTitle | default "Contact" }}</h2>
  <div class="section--narrow">
    <p>{{ .Params.contactText }}</p>
    <p><a href="mailto:{{ .Site.Params.contactEmail }}">{{ .Site.Params.contactEmail }}</a></p>
    {{ with .Params.contactPhone }}
    <p><a href="tel:{{ . }}">{{ . }}</a></p>
    {{ end }}
  </div>
</section>
{{ end }}
